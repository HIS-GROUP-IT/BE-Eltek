{"version":3,"sources":["../../src/utils/s3.ts"],"sourcesContent":["import { S3Client, PutObjectCommand, DeleteObjectCommand ,ListObjectVersionsCommand} from \"@aws-sdk/client-s3\";\r\nimport fs from \"fs\";\r\nimport { HttpException } from \"@/exceptions/HttpException\";\r\nimport { AWS_ACCESS_KEY_ID, AWS_REGION, AWS_S3_BUCKET_NAME, AWS_SECRET_ACCESS_KEY } from \"@/config\";\r\nimport { logger } from \"./logger\";\r\n\r\n\r\nconst s3 = new S3Client({\r\n    region: AWS_REGION,\r\n    credentials: {\r\n        accessKeyId: AWS_ACCESS_KEY_ID!,\r\n        secretAccessKey: AWS_SECRET_ACCESS_KEY!\r\n    }\r\n});\r\n\r\n\r\nexport const uploadFileToS3 = async (filePath: string, fileName: string, mimeType: string): Promise<string> => {\r\n    try {\r\n        const fileStream = fs.createReadStream(filePath);\r\n\r\n        const uploadParams = {\r\n            Bucket: AWS_S3_BUCKET_NAME!,\r\n            Key: `leaves/${fileName}`,\r\n            Body: fileStream,\r\n            ContentType: mimeType  \r\n        };\r\n\r\n        const uploadCommand = new PutObjectCommand(uploadParams);\r\n        await s3.send(uploadCommand);\r\n        fs.unlinkSync(filePath);\r\n        \r\n        return `https://${AWS_S3_BUCKET_NAME}.s3.${AWS_REGION}.amazonaws.com/uploads/${fileName}`;\r\n    } catch (error) {\r\n        throw new HttpException(500, \"Error uploading file to S3\");\r\n    }\r\n};\r\n\r\n\r\nexport const deleteFileFromS3 = async (fileName: string): Promise<void> => {\r\n    try {\r\n        const bucketName = process.env.AWS_S3_BUCKET_NAME!;\r\n        const objectKey = `${fileName}`;\r\n\r\n        const { Versions } = await s3.send(new ListObjectVersionsCommand({ Bucket: bucketName, Prefix: objectKey }));\r\n\r\n        if (!Versions || Versions.length === 0) {\r\n            logger.info(\"No versions found, skipping deletion.\");\r\n            return;\r\n        }\r\n\r\n        for (const version of Versions) {\r\n            const deleteParams = {\r\n                Bucket: bucketName,\r\n                Key: objectKey,\r\n                VersionId: version.VersionId,\r\n            };\r\n            await s3.send(new DeleteObjectCommand(deleteParams));\r\n        }\r\n\r\n        logger.info(`Deleted all versions of ${fileName}`);\r\n    } catch (error) {\r\n        console.error(\"Error deleting file from S3:\", error);\r\n    }\r\n};\r\n"],"names":["deleteFileFromS3","uploadFileToS3","s3","S3Client","region","AWS_REGION","credentials","accessKeyId","AWS_ACCESS_KEY_ID","secretAccessKey","AWS_SECRET_ACCESS_KEY","filePath","fileName","mimeType","fileStream","fs","createReadStream","uploadParams","Bucket","AWS_S3_BUCKET_NAME","Key","Body","ContentType","uploadCommand","PutObjectCommand","send","unlinkSync","error","HttpException","bucketName","process","env","objectKey","Versions","ListObjectVersionsCommand","Prefix","length","logger","info","version","deleteParams","VersionId","DeleteObjectCommand","console"],"mappings":";;;;;;;;;;;IAsCaA,gBAAgB;eAAhBA;;IAtBAC,cAAc;eAAdA;;;0BAhB6E;2DAC3E;+BACe;wBAC2D;wBAClE;;;;;;AAGvB,MAAMC,KAAK,IAAIC,kBAAQ,CAAC;IACpBC,QAAQC,kBAAU;IAClBC,aAAa;QACTC,aAAaC,yBAAiB;QAC9BC,iBAAiBC,6BAAqB;IAC1C;AACJ;AAGO,MAAMT,iBAAiB,OAAOU,UAAkBC,UAAkBC;IACrE,IAAI;QACA,MAAMC,aAAaC,WAAE,CAACC,gBAAgB,CAACL;QAEvC,MAAMM,eAAe;YACjBC,QAAQC,0BAAkB;YAC1BC,KAAK,CAAC,OAAO,EAAER,UAAU;YACzBS,MAAMP;YACNQ,aAAaT;QACjB;QAEA,MAAMU,gBAAgB,IAAIC,0BAAgB,CAACP;QAC3C,MAAMf,GAAGuB,IAAI,CAACF;QACdR,WAAE,CAACW,UAAU,CAACf;QAEd,OAAO,CAAC,QAAQ,EAAEQ,0BAAkB,CAAC,IAAI,EAAEd,kBAAU,CAAC,uBAAuB,EAAEO,UAAU;IAC7F,EAAE,OAAOe,OAAO;QACZ,MAAM,IAAIC,4BAAa,CAAC,KAAK;IACjC;AACJ;AAGO,MAAM5B,mBAAmB,OAAOY;IACnC,IAAI;QACA,MAAMiB,aAAaC,QAAQC,GAAG,CAACZ,kBAAkB;QACjD,MAAMa,YAAY,GAAGpB,UAAU;QAE/B,MAAM,EAAEqB,QAAQ,EAAE,GAAG,MAAM/B,GAAGuB,IAAI,CAAC,IAAIS,mCAAyB,CAAC;YAAEhB,QAAQW;YAAYM,QAAQH;QAAU;QAEzG,IAAI,CAACC,YAAYA,SAASG,MAAM,KAAK,GAAG;YACpCC,cAAM,CAACC,IAAI,CAAC;YACZ;QACJ;QAEA,KAAK,MAAMC,WAAWN,SAAU;YAC5B,MAAMO,eAAe;gBACjBtB,QAAQW;gBACRT,KAAKY;gBACLS,WAAWF,QAAQE,SAAS;YAChC;YACA,MAAMvC,GAAGuB,IAAI,CAAC,IAAIiB,6BAAmB,CAACF;QAC1C;QAEAH,cAAM,CAACC,IAAI,CAAC,CAAC,wBAAwB,EAAE1B,UAAU;IACrD,EAAE,OAAOe,OAAO;QACZgB,QAAQhB,KAAK,CAAC,gCAAgCA;IAClD;AACJ"}